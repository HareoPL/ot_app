<!DOCTYPE html>
<html lang="pl" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ESP32-C6 application</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 2rem;
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        #response {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="d-flex flex-column align-items-center">
    <div class="container-lg">
        <div class="row justify-content-center">
            <div class="col-12 col-md-8 col-lg-6">
                <h1 class="mb-4 text-center">Set color</h1>
                
                <div class="card shadow">
                    <div class="card-body">
                        <form id="sensorForm" class="needs-validation" novalidate>
                            <!-- <div class="mb-3">
                                <label for="sensor" class="form-label">Sensor name</label>
                                <input type="text" class="form-control" id="sensor" 
                                       placeholder="e.g. Temperature" required>
                                <div class="invalid-feedback">
                                    Please provide a sensor name
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="value" class="form-label">Value</label>
                                <input type="number" class="form-control" id="value" 
                                       step="0.1" placeholder="e.g. 25.5" required>
                                <div class="invalid-feedback">
                                    Please enter a numeric value
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="unit" class="form-label">Unit</label>
                                <select class="form-select" id="unit">
                                    <option value="°C">°C</option>
                                    <option value="%">%</option>
                                    <option value="hPa">hPa</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="location" 
                                       placeholder="e.g. Room 101">
                            </div> -->
                            <div class="mb-3">
                                <label for="color" class="form-label">Barwa (RGB)</label>
                                <input type="color" class="form-control form-control-color" id="color" value="#ff0000" title="Wybierz barwę RGB">
                            </div>

                            

                            <button type="button" 
                                    class="btn btn-primary w-100 py-2"
                                    onclick="sendData()">
                                <span class="fs-5">Send Data</span>
                            </button>
                        </form>
                    </div>
                </div>

                <div id="response" class="alert alert-info mt-4 mb-0"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS + Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Form validation
        (() => {
          'use strict'
          const forms = document.querySelectorAll('.needs-validation')
          
          Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
              if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
              }
              form.classList.add('was-validated')
            }, false)
          })
        })()

        // Funkcja do konwersji HEX na RGB
        function hexToRgb(hex) {
            hex = hex.replace(/^#/, '');
            if (hex.length === 3) {
                hex = hex.split('').map(x => x + x).join('');
            }
            const num = parseInt(hex, 16);
            return {
                r: (num >> 16) & 255,
                g: (num >> 8) & 255,
                b: num & 255
            };
        }

        async function sendData() {
            const form = document.getElementById('sensorForm')
            const responseDiv = document.getElementById('response')
            
            if (!form.checkValidity()) {
                form.classList.add('was-validated')
                return
            }

            // Pobierz kolor i konwertuj na RGB
            const colorHex = document.getElementById('color').value;
            const colorRgb = hexToRgb(colorHex);

            const jsonData = {
                // sensor: document.getElementById('sensor').value,
                // value: parseFloat(document.getElementById('value').value),
                // unit: document.getElementById('unit').value,
                // location: document.getElementById('location').value || 'undefined',
                color: {
                    hex: colorHex,
                    rgb: colorRgb
                },
                timestamp: new Date().toISOString()
            };

            try {
                const response = await fetch('http://192.168.4.1/api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jsonData)
                });

                const data = await response.json();
                responseDiv.innerHTML = `<strong>Status:</strong> ${response.status}\n` +
                                      `<strong>Response:</strong>\n${JSON.stringify(data, null, 2)}`;
                
                responseDiv.classList.remove('alert-danger', 'alert-info');
                responseDiv.classList.add(response.ok ? 'alert-success' : 'alert-danger');
                
            } catch (error) {
                responseDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
                responseDiv.classList.remove('alert-info', 'alert-success');
                responseDiv.classList.add('alert-danger');
            }
        }
    </script>
</body>
</html>
